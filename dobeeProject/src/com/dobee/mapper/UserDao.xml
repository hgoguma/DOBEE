<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dobee.dao.UserDao">
	
	<!--  -->
	<select id="getUserList" resultType="com.dobee.vo.member.User">
		SELECT MAIL, NAME, MYPIC, AUTHCODE, TEAMCODE 
		FROM USER
	</select>
	
	<!-- User 정보 가져오기 -->
	<select id="getUser" resultType="com.dobee.vo.member.User">
		SELECT MAIL, PASSWORD, NAME, MYPIC, AUTHCODE FROM USER WHERE MAIL=#{mail}
	</select>
	
	
	<!-- UserInfo 정보가져오기 -->
	<select id="getUserInfoList" resultType="com.dobee.vo.member.UserInfo">
		SELECT MAIL, REGITDATE, SERVE, EMP, POSITION, PHONE FROM USERINFO
	</select>
	
	
	<!-- Ajax 신청코드 불러오기 -->
	<select id="getApyCode" resultType="com.dobee.vo.ApplyCode">
		SELECT APYCODE, ENTRY FROM APPLYCODE
	</select>
	
		
	<!-- Ajax 결재자 불러오귀 // AUTHCODE=1 팀장 -->
	<select id="getApprovalList" resultType="com.dobee.vo.member.User">
		SELECT MAIL, NAME FROM USER WHERE AUTHCODE=1
	</select>
	
	
	<!-- Ajax 연장근무 년도 불러오기 -->
	<select id="overTimeYearList" parameterType="String" resultType="Integer">
		SELECT DISTINCT DATE_FORMAT(ATTTIME, '%Y') FROM ATTEND WHERE MAIL = ${param1}
	</select>
	
	
	<!-- Ajax 연장근무 월 불러오기 -->
	<select id="overTimeMonthList" parameterType="String" resultType="Integer">
		SELECT DISTINCT DATE_FORMAT(ATTTIME, '%c') FROM ATTEND WHERE MAIL = ${param1}
	</select>
	
	
	<!-- 연장근무 신청하기 0112 -->
	<insert id="overTimeApply" parameterType="com.dobee.vo.Apply">
		INSERT INTO APPLY (REQDATE, REASON, STARTAT, ENDAT, ISAUTH, DRAFTER, APPROVAL, APYCODE)
			VALUES (CURDATE(), #{reason}, #{startAt}, #{endAt}, '미승인', #{drafter}, #{approval}, 6)
	</insert>
		
	
	<!-- 부재 신청하기 0112 -->
	<insert id="absApply" parameterType="com.dobee.vo.Apply">
		INSERT INTO APPLY (REQDATE, REASON, STARTAT, ENDAT, ISAUTH, DRAFTER, APPROVAL, APYCODE)
			VALUES (CURDATE(), #{reason}, #{startAt}, #{endAt}, '미승인', #{drafter}, #{approval}, #{apyCode})
	</insert>
	
	
	<!-- Ajax 연차 불러오기 0112 -->
	<select id="getVacationInBM" parameterType="String" resultType="com.dobee.vo.member.Break">
		SELECT TOTALBREAK, USEDBREAK FROM BREAK WHERE MAIL=#{param1}
	</select>
	
	
	<!-- Ajax 개인부재일정확인 - Option - 년도 loading		0113 -->
	<select id="breakYearList" parameterType="String" resultType="Integer">
		SELECT DISTINCT DATE_FORMAT(STARTAT, '%Y') FROM APPLY WHERE APYCODE != 6 AND  DRAFTER=#{param1}
	</select>
	
	
	<!-- Ajax 개인부재일정확인 - 년도별 List 출력		0113 -->
	<select id="getBreakListByYear" parameterType="String" resultType="com.dobee.vo.member.BreakManageList">
		SELECT a.aplseq, AC.ENTRY, A.REQDATE, A.STARTAT, A.ENDAT, A.ISAUTH, A.APPROVAL, BL.USINGBREAK, A.REASON, A.REJREASON
			FROM APPLY A
				INNER JOIN APPLYCODE AC
					ON A.APYCODE = AC.APYCODE
				LEFT OUTER JOIN BREAKLIST BL
					ON A.APLSEQ = BL.APLSEQ
			WHERE  A.APYCODE != 6 AND A.DRAFTER=#{param1} AND DATE_FORMAT(A.STARTAT, '%Y') = 2020;
	</select>
	
	
	<!-- Ajax 개인부재일정확인 - Option - 월 loading		0113 -->
	<select id="breakYearMonthList" parameterType="String" resultType="String">
		SELECT DISTINCT DATE_FORMAT(STARTAT, '%Y-%m') AS STARTAT FROM APPLY WHERE APYCODE != 6 AND  DRAFTER=#{param1}
	</select>
	
	
	<!-- Ajax 개인부재일정확인 - 년-월별 List 출력		0113 -->
	<select id="getBreakListByYMonth" parameterType="String" resultType="com.dobee.vo.member.BreakManageList">
		SELECT a.aplseq, AC.ENTRY, A.REQDATE, A.STARTAT, A.ENDAT, A.ISAUTH, A.APPROVAL, BL.USINGBREAK, A.REASON, A.REJREASON
			FROM APPLY A	
				INNER JOIN APPLYCODE AC
					ON A.APYCODE = AC.APYCODE
				LEFT OUTER JOIN BREAKLIST BL
					ON A.APLSEQ = BL.APLSEQ
			WHERE  A.APYCODE != 6 AND A.DRAFTER=#{param1} AND DATE_FORMAT(A.STARTAT, '%Y-%m') = '2020-01';
	</select>
	
	
	<!-- Ajax 개인부재일정확인 - Option - 부재항목 loading		0113 -->
	<select id="breakEntryList" parameterType="String" resultType="com.dobee.vo.ApplyCode">
		SELECT DISTINCT AC.APYCODE, AC.ENTRY 
			FROM APPLY A
				INNER JOIN APPLYCODE AC
	        		ON A.APYCODE = AC.APYCODE
			WHERE A.APYCODE != 6 AND  A.DRAFTER=#{param1}
	</select>
	
	
	<!-- Ajax 개인부재일정확인 - 부재항목 별 List 출력		0113 -->
	<select id="getBreakListByEntry" parameterType="String" resultType="com.dobee.vo.member.BreakManageList">
		SELECT a.aplseq, AC.ENTRY, A.REQDATE, A.STARTAT, A.ENDAT, A.ISAUTH, A.APPROVAL, BL.USINGBREAK, A.REASON, A.REJREASON
			FROM APPLY A
				INNER JOIN APPLYCODE AC
					ON A.APYCODE = AC.APYCODE
				LEFT OUTER JOIN BREAKLIST BL
					ON A.APLSEQ = BL.APLSEQ
			WHERE  A.DRAFTER=#{param1} AND A.APYCODE = '2';
	</select>
	
	
	<!-- Ajax 개인부재일정확인 - Option - 승인여부 loading		0113 -->
	<select id="breakIsAuthList" parameterType="String" resultType="String">
		SELECT DISTINCT ISAUTH FROM APPLY WHERE APYCODE != 6 AND  DRAFTER=#{param1}
	</select>
	
	
	<!-- Ajax 개인부재일정확인 - 승인여부 별  List 출력		0113 -->
	<select id="getBreakListByIsAuth" parameterType="String" resultType="com.dobee.vo.member.BreakManageList">
		SELECT a.aplseq, AC.ENTRY, A.REQDATE, A.STARTAT, A.ENDAT, A.ISAUTH, A.APPROVAL, BL.USINGBREAK, A.REASON, A.REJREASON
			FROM APPLY A
				INNER JOIN APPLYCODE AC
					ON A.APYCODE = AC.APYCODE
				LEFT OUTER JOIN BREAKLIST BL
					ON A.APLSEQ = BL.APLSEQ
			WHERE  A.APYCODE != 6 AND A.DRAFTER=#{param1} AND A.ISAUTH = '미승인';
	</select>
	
	
	<!-- 부재내역 불러오기 - COMPLETE -->
	<select id="absMg" parameterType="com.dobee.vo.Apply" resultType="com.dobee.vo.member.BreakManageList">
		SELECT A.APLSEQ, AC.ENTRY, A.REQDATE, A.STARTAT, A.ENDAT, A.ISAUTH, A.APPROVAL, BL.USINGBREAK, A.REASON, A.REJREASON
			FROM APPLY A
			    INNER JOIN APPLYCODE AC
					ON A.APYCODE = AC.APYCODE
				LEFT OUTER JOIN BREAKLIST BL
					ON A.APLSEQ = BL.APLSEQ
		    WHERE A.APYCODE != 6 AND A.DRAFTER = #{drafter}
	</select>
	
	
	<!-- Ajax 매니저_부재관리 - Option - 부재항목 loading		0114 -->
    <select id="breakEntryListMgr" resultType="com.dobee.vo.ApplyCode">
    	SELECT DISTINCT AC.APYCODE, AC.ENTRY 
			FROM APPLY A
				INNER JOIN APPLYCODE AC
	        		ON A.APYCODE = AC.APYCODE
			WHERE A.APYCODE != 6
    </select>
    
    
    <!-- 매니저_부재관리 - 데이터 테이블 출력 (GET)		0114 -->
    <select id="breakListMgr" resultType="com.dobee.vo.member.BreakManageList">
    	SELECT A.APLSEQ, AC.ENTRY, A.REQDATE, A.STARTAT, A.ENDAT, A.ISAUTH, A.APPROVAL, BL.USINGBREAK, A.REASON, A.REJREASON, A.DRAFTER, U.NAME
			FROM APPLY A
			    INNER JOIN APPLYCODE AC
					ON A.APYCODE = AC.APYCODE
				LEFT OUTER JOIN BREAKLIST BL
					ON A.APLSEQ = BL.APLSEQ
				INNER JOIN USER U
					ON A.DRAFTER = U.MAIL
		    WHERE A.APYCODE != 6
		    ORDER BY A.APLSEQ ASC
    </select>
    
    
    <!-- 매니저_부재관리 - isAuth update (POST)		0115 -->
    <update id="absReqHandle" parameterType="com.dobee.vo.Apply">
    	UPDATE APPLY SET REJREASON = #{rejReason}, ISAUTH = #{isAuth} WHERE APLSEQ = #{aplSeq}
    </update>
	
	
    <!-- 매니저_연장근무 관리 - 데이터 테이블 출력 (GET)		0115 -->
    <select id="extListMgr" resultType="com.dobee.vo.member.BreakManageList">
    	SELECT A.APLSEQ, U.NAME, AC.ENTRY, A.REQDATE, A.STARTAT, A.ENDAT, A.ISAUTH, A.DRAFTER, A.APPROVAL, BL.USINGBREAK, A.REASON, A.REJREASON
			FROM APPLY A
				INNER JOIN APPLYCODE AC
					ON A.APYCODE = AC.APYCODE
				LEFT OUTER JOIN BREAKLIST BL
					ON A.APLSEQ = BL.APLSEQ
				INNER JOIN USER U
					ON A.DRAFTER = U.MAIL
			WHERE A.APYCODE = 6
			ORDER BY A.APLSEQ ASC
    </select>
    
    
    <!-- 매니저_부재관리 - isAuth update (POST)		0115 ~ing -->
    <update id="extReqHandle" parameterType="com.dobee.vo.Apply">
    	UPDATE APPLY SET REJREASON = #{rejReason}, ISAUTH = #{isAuth} WHERE APLSEQ = #{aplSeq}
    </update>
	
	
	<!-- 권한목록 불러오기 -->
	<select id="getAuthority" resultType="com.dobee.vo.member.Authority">
		SELECT AUTH, AUTHCODE FROM AUTHORITY
	</select>
	
	
	<!-- 팀목록 불러오기 -->
	<select id="getTeamList" resultType="com.dobee.vo.member.TeamList">
		SELECT TEAMCODE, TEAMNAME FROM TEAMLIST
	</select>
	
	
	<!-- 사원등록 -->
	<insert id="addUser" parameterType="com.dobee.vo.member.User">
		INSERT INTO USER (MAIL, NAME, MYPIC, AUTHCODE, TEAMCODE) VALUES (#{mail},#{name},#{myPic},#{authCode},#{teamCode})
	</insert>
	
	<!-- 사원정보등록 -->
	<insert id="addUserInfo" parameterType="com.dobee.vo.member.UserInfo">
		INSERT INTO USERINFO (MAIL, REGITDATE, SERVE, EMP, POSITION, PHONE) VALUES (#{mail},'2020-01-20',#{serve},#{emp},#{position},#{phone})
	</insert>
	
	
	<!-- 비밀번호등록 -->
	<update id="resetPwd" parameterType="com.dobee.vo.member.User">
		UPDATE USER SET PASSWORD=#{password} WHERE MAIL=#{mail}
	</update>
	
	
	<!-- 팀 리스트 조회 -->
	<select id="teamList" resultType="com.dobee.vo.member.TeamList">
		SELECT TEAMCODE, TEAMNAME FROM TEAMLIST ORDER BY TEAMCODE ASC
	</select>
	
	
	<!-- 팀 조회 -->
	<select id="getTeam" resultType="com.dobee.vo.member.TeamList">
		SELECT TEAMCODE, TEAMNAME FROM TEAMLIST WHERE TEAMCODE=#{teamCode}
	</select>
</mapper>
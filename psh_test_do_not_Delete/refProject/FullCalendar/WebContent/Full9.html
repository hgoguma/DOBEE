<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
<title>풀캘린더</title>
<style type="text/css">
    body {
        margin :40px 10px;
        padding : 0;
        font-family : "Lucida Grande", Helvetica, Arial, Verdana,sans-serif;
        font-size : 14px;
    }
    #calendar {
        max-width : 900px;
        margin : 0 auto;
    }
</style>
<link href="./fullcalendar-2.9.1/fullcalendar.css" rel="stylesheet"/>
<link href="./fullcalendar-2.9.1/fullcalendar.print.css" rel="stylesheet" media="print"/>
<script type="text/javascript" src="./fullcalendar-2.9.1/lib/moment.min.js"></script>
<script type="text/javascript" src="./fullcalendar-2.9.1/lib/jquery.min.js"></script>
<script type="text/javascript" src="./fullcalendar-2.9.1/fullcalendar.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    var lang_cd = 'ko';
    $('#calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,listMonth'
        },
        defaultDate: moment().format('YYYY-MM-DD'),
        locale: initialLocaleCode,
        editable: true,
        navLinks: true,
        eventLimit: true,
        events: function(start, end, timezone, callback) {
            $.ajax({
                url: '/test/eventAll.do',
                type : 'post',
                data : {EVENT_CODE : '11', LANG : lang_cd, startDate : start.format(), endDate : end.format() },
                dataType: 'json',
                success: function(data) {
                    var events = [];
                    $(data).each(function() {
                        events.push({
                            title: $(this).attr('title'),
                            start: $(this).attr('start'),
                            end: $(this).attr('end'),
                            url: "/test/eventDetail.do?id="+$(this).attr('id')+"&amp;lang="+$(this).attr('lang')+"&amp;start="+$(this).attr('start')+"&amp;end="+$(this).attr('end'),
                            lang : $(this).attr('lang')
                        });
                    });
                    callback(events);
                }
            });
 
        },
        loading: function(bool) {
            $('#loading').toggle(bool);
        }
    });
});








$('#calendar').fullCalendar({
	  header: {
	    left: '',
	    center: 'title',
	    right: 'today prev,next'
	  },
	  defaultView: 'month',
	  defaultDate: date.yyyymmdd(),
	  eventLimit: 3,
	      eventLimitText: "더보기",
	      eventLimitClick: "popover",
	      editable: false,
	      droppable: false,
	      height: "parent",
	      eventSources: getTodayDate()
	});
	$(".fc-prev-button").on("click", function() {
	  //alert("!!!");
	  getViewDate();
	});
	$(".fc-next-button").on("click", function() {
	  //alert("next!!!");
	  getViewDate();
	});
	$(".fc-today-button").on("click", function() {
	  //alert("next!!!");
	  getViewDate();
	});
	 
	function renderCalcEvent(data) {
	  for (var i = 0; i < data.length; i++) {
	    var locIdx = data[i].locationIdx;
	    var eventIdx = data[i].eventIdx;
	    var sdate = new Date(data[i].regDt).toString();
	    var edate = new Date(data[i].regDt).toString();
	    var col = "blue";
	    var date = data[i].regDt;
	 
	    var event = {
	      id: data[i].eventIdx,
	      title: data[i].locationName,
	      url: '/',
	      start: moment(data[i].regDt),
	      allDay: false,
	      color: col
	    };
	 
	    $('#calendar').fullCalendar('renderEvent', event);
	  }
	}
	function calEvent(dayObj, locationIdx) {
		  url = "/";
		  $.ajax({
		    dataType: "json",
		    data: dayObj,
		    method: "POST",
		    url: url,
		    async: false,
		    success: function(data) {
		      if (data.state == "success") {
		        renderCalcEvent(data.calEvent);
		      }
		    },
		    error: function(request, status, error) {
		      alert("code:" + request.status + "\n" + "message:" +
		        request.responseText + "\n" + "error:" +
		        error);
		    }
		  });
		}
		 
		function getViewDate() {
		  var date = $('#calendar').fullCalendar('getView');
		  console.log(date.intervalStart.format('YYYY-MM-DD'));
		  console.log(date.intervalEnd.subtract(1, "days").format('YYYY-MM-DD'));
		  var monthObj = {
		    startDate: date.intervalStart.format('YYYY-MM-DD'),
		    endDate: date.intervalEnd.subtract(1, "days").format('YYYY-MM-DD')
		  };
		  $('#calendar').fullCalendar('removeEvents');
		  calEvent(monthObj, '');
		  
		  
	/*  event */
	/*
		  events: [
            <c:forEach var="items" items="${requestScope.attList}" varStatus="status">
                {
                    title: '${items.statue}',
                    start: '${items.adate}'
                    <c:choose>
                        <c:when test="${items.statue=='결석'}">,color : '#FB5175'</c:when>
                        <c:when test="${items.statue=='지각'||items.statue=='조퇴'||items.statue=='외출'}">,color : '#dddddd'</c:when>
                        <c:otherwise>,color : '#337AB7' </c:otherwise>
                    </c:choose>
                },
            </c:forEach>
            ]

		  //////////////////////////////////////////////////////////////////////////////////////
		  
		   eventClick: function(calEvent, jsEvent, view) {
                var cdate = calEvent.id;
                var checkDay = new Date(cdate);
                if (checkDay.getDay() == 6 || checkDay.getDay() == 0) {
                    bootbox.alert("주말은 출석일이 아닙니다.", function() {});
                }
                else{
                    $.ajax({
                        type:"post",
                        url:"../attendance/selectDay",
                        data: {date:cdate},
                        dataType:"json",
                        success:function(obj){
                            var userin = obj.userin;
                            var userout = obj.userout;
                            bootbox.dialog({
                                title: cdate+" 출결 정보",
                                message: "<div style=\"text-align:center;\"><strong>입실시간</strong><p>"+userin+"</p>"+
                                "<strong>퇴실시간</strong><p>"+userout+"</p>"+
                                "</div>" ,
                                buttons: {
                                    success: {
                                        label: "확인",
                                        className: "btn-success",
                                    }
                                }
                            }
                        );
                        },
                        error:function(xhr,status,error){
                            console.log('실패: '+error);
                        },
                        complete:function(data){
                            
                        }
                        
                    }); 
                }
 
            }
  
		  
            select * from(
            		  SELECT UserID, ADATE, userin, userout, ATEXCEPTION, 
            		    CASE  WHEN (USERIN is null or USEROUT is null) THEN '결석'
            		          WHEN USERIN>(SELECT starttime FROM(
            		                          SELECT * 
            		                          FROM member m join EDUCLASS e
            		                          on m.EDUCLASS = e.NUM
            		                        )where userid='user') 
            		                        AND USEROUT<(SELECT endtime FROM(
            		                          SELECT * 
            		                          FROM member m join EDUCLASS e
            		                          on m.EDUCLASS = e.NUM
            		                        )where userid='user') THEN '결석'
            		          WHEN USERIN>(SELECT starttime FROM(
            		                          SELECT * 
            		                          FROM member m join EDUCLASS e
            		                          on m.EDUCLASS = e.NUM
            		                        )where userid='user') THEN '지각'
            		          WHEN USEROUT<(SELECT endtime FROM(
            		                          SELECT * 
            		                          FROM member m join EDUCLASS e
            		                          on m.EDUCLASS = e.NUM
            		                        )where userid='user') THEN '조퇴'
            		          else '출석' end AS STATUE FROM BEPRESENT 
            		)where userid='user';



            
     */

		  
		  
		  
</script>
<body>
    <div id="calendar"></div>
</body>
</html>
